# System Engineer Handoff: Diagnose and Resolve AI Streaming "Forbidden" Errors

## Problem Statement

The production Next.js application deployed on Netlify is experiencing "Forbidden" errors when calling AI streaming endpoints (`/api/chat`, `/api/assistant/chat`, `/api/consultant/chat`). The user discovered that **no functions are visible in Netlify** when running `netlify functions:list`, which may be related to the deployment issue.

## Critical Discovery

**NO FUNCTIONS VISIBLE IN NETLIFY**: When checking `netlify functions:list`, the system reports "No functions found in /home/chris/projects/app.startupai.site/netlify/functions". This is a RED FLAG that requires immediate investigation.

## Project Architecture

### Technology Stack
- **Framework**: Next.js 15.5.3 with `output: 'standalone'` mode
- **Hosting**: Netlify with `@netlify/plugin-nextjs@5.14.5`
- **AI SDK**: Vercel AI SDK v5.0.82 with OpenAI and Anthropic providers
- **Auth/DB**: Supabase (SSR v0.7.0)
- **Deployment**: Auto-deploy from GitHub `main` branch

### Project Structure
```
frontend/
├── src/app/api/           # Next.js API routes (should be deployed as serverless functions)
│   ├── chat/route.ts
│   ├── assistant/chat/route.ts
│   └── consultant/chat/route.ts
├── netlify.toml           # Netlify configuration
├── next.config.js         # Next.js configuration (output: 'standalone')
└── .next/                 # Build output
```

## Recent Commit History (Last 15 Commits)

Analysis of recent fixes attempted:

1. **fb4c322** (Latest): "feat: add comprehensive error logging for debugging Forbidden errors"
   - Added detailed diagnostic logging throughout streaming endpoints
   - Logs incoming requests, auth details, streamText() calls
   - Enhanced error logging with full error objects

2. **b00232c**: "debug: add error logging to AI streaming endpoints"
   - Additional error logging

3. **0c77dd8**: "fix: use toUIMessageStreamResponse for AI SDK 5.0 streaming with tool calls"
   - Changed from `toTextStreamResponse()` to `toUIMessageStreamResponse()`
   - AI SDK 5.0 migration fix for tool calling support

4. **4aba127**: "fix: enable Supabase session refresh in middleware"
   - Enabled session refresh in middleware

5. **63eafab**: "fix: set trailingSlash to false to prevent 308 redirects breaking streaming API routes"
   - Fixed trailing slash configuration

6. **8db388e**: "fix: bypass Netlify AI Gateway to call OpenAI directly"
   - **CRITICAL**: Root cause was Vercel AI SDK routing through Netlify AI Gateway (`.netlify/ai/messages`) which is NOT enabled on the account
   - Fixed by configuring OpenAI provider with explicit `baseURL: 'https://api.openai.com/v1'`
   - Fixed fallback model from invalid 'gpt-4.1-nano' to 'gpt-4o-mini'

## Current Deployment Status

### Latest Deploy (6913cf11fc86dc0008df71b3)
- **State**: ready
- **Deployed**: 2025-11-12T00:06:32.585Z
- **Commit**: fb4c322 (error logging commit)
- **Deploy Time**: 118 seconds
- **Functions Deployed**: 1 function called `___netlify-server-handler` (Next.js Server Handler)
  - Generated by `@netlify/plugin-nextjs@5.14.5`
  - Route pattern: `/*` (catches all routes)
  - Runtime: `nodejs22.x`
  - Region: `us-east-2`

**IMPORTANT**: The deployment shows "1 function deployed" (`___netlify-server-handler`), which suggests Next.js routes ARE being bundled. However, `netlify functions:list` shows NO functions, which is suspicious.

## Key Configuration Files

### netlify.toml
```toml
[build]
  command = "pnpm build"
  publish = "frontend/.next"

[functions]
  directory = "netlify/functions"  # ← Traditional functions directory

[[plugins]]
  package = "@netlify/plugin-nextjs"  # ← Handles Next.js API routes

[[redirects]]
  from = "/api/analyze-background"
  to = "/.netlify/functions/crew-analyze-background"
  status = 200
```

### next.config.js
```javascript
{
  output: 'standalone',  // Required for Netlify deployment
  trailingSlash: false,  // Fixed: prevents 308 redirects breaking streaming
  outputFileTracingRoot: path.join(__dirname, '../'),  // Fix for pnpm workspace
}
```

### Environment Variables (Production)
The following are configured in Netlify:
- `OPENAI_API_KEY` ✓
- `ANTHROPIC_API_KEY` (check if present)
- `NEXT_PUBLIC_SUPABASE_URL` ✓
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` ✓
- `SUPABASE_SERVICE_ROLE_KEY` ✓
- `DATABASE_URL` ✓
- `NODE_VERSION` ✓
- `PNPM_VERSION` ✓

## AI Model Configuration

Current implementation in `/api/chat/route.ts`:

```typescript
function getAIModel() {
  // Prefer Anthropic Claude for conversational quality
  if (process.env.ANTHROPIC_API_KEY) {
    return anthropic('claude-3-5-sonnet-20241022');
  }

  // Use OpenAI directly, bypassing Netlify AI Gateway
  if (process.env.OPENAI_API_KEY) {
    const openai = createOpenAI({
      apiKey: process.env.OPENAI_API_KEY,
      baseURL: 'https://api.openai.com/v1',  // ← Bypass Netlify AI Gateway
    });
    const model = process.env.OPENAI_MODEL_DEFAULT || 'gpt-4o-mini';
    return openai(model);
  }

  throw new Error('No AI provider configured');
}
```

## Diagnosis Checklist

Your task is to systematically diagnose and resolve the issue. Work through these steps:

### 1. Verify Netlify Function Deployment

- [ ] Check Netlify admin UI → Deploys → Latest deploy → Function logs
- [ ] Verify if `___netlify-server-handler` function exists and is deployed
- [ ] Check if API routes are being bundled into the Next.js server handler
- [ ] Look for any deployment warnings or errors related to function bundling

**CRITICAL QUESTION**: Why does `netlify functions:list` show no functions when the deployment API shows `___netlify-server-handler` was deployed?

### 2. Check Build Output

- [ ] Examine `.next/standalone` directory structure
- [ ] Verify `.next/server/app/api/` contains compiled API routes
- [ ] Check if `next.config.js` standalone mode is correctly configured
- [ ] Verify `@netlify/plugin-nextjs` is properly processing the build

### 3. Review Netlify Deployment Logs

Access deployment logs to check:
- [ ] Build step: Did Next.js build complete successfully?
- [ ] Plugin step: Did `@netlify/plugin-nextjs` run correctly?
- [ ] Function bundling: Were API routes converted to serverless functions?
- [ ] Any warnings about missing dependencies or incompatible packages?

### 4. Test Function Endpoints

- [ ] Attempt to call `https://app-startupai-site.netlify.app/api/chat` directly
- [ ] Check response headers for clues (X-Netlify-*, X-Nf-Request-Id, etc.)
- [ ] Verify if middleware is executing (Supabase session refresh)
- [ ] Test with authenticated request (valid Supabase session cookie)

### 5. Analyze Error Logs

The latest deployment (fb4c322) added comprehensive error logging. Check Netlify Function logs for:
- [ ] `[api/chat] Request received:` - Incoming request logging
- [ ] `[api/chat] User authenticated:` - Auth verification
- [ ] `[api/chat] Calling streamText with:` - AI SDK call logging
- [ ] `[api/chat] Stream error in toUIMessageStreamResponse:` - Streaming errors
- [ ] `[api/chat] Top-level error:` - Uncaught errors

**How to access logs**:
- Netlify UI: Projects → app-startupai-site → Logs → Functions
- CLI: Check if there's a way to tail function logs (note: `netlify functions:log` doesn't exist)

### 6. Verify Next.js Plugin Configuration

Potential issues with `@netlify/plugin-nextjs`:
- [ ] Check if plugin version `5.14.5` is compatible with Next.js `15.5.3`
- [ ] Verify if standalone mode is fully supported
- [ ] Check if there are any known issues with AI SDK streaming and Netlify
- [ ] Consider if middleware is interfering with function routing

### 7. Environment Variable Verification

- [ ] Confirm `OPENAI_API_KEY` or `ANTHROPIC_API_KEY` exists in production
- [ ] Verify all Supabase environment variables are set correctly
- [ ] Check if `NODE_ENV=production` is set (may affect behavior)

### 8. Middleware Analysis

Check if middleware is blocking API routes:
- [ ] Review `src/middleware.ts` and `src/lib/supabase/middleware.ts`
- [ ] Verify middleware matcher pattern doesn't conflict with API routes
- [ ] Check if Supabase session refresh is causing issues

Current middleware matcher:
```typescript
matcher: [
  '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
]
```

**Question**: Should API routes be excluded from middleware? Or is the issue with how middleware handles API route requests?

## Known Issues and Fixes Applied

### ✓ Fixed: Netlify AI Gateway Issue (8db388e)
- **Symptom**: 403 Forbidden when Vercel AI SDK routed through `.netlify/ai/messages`
- **Cause**: Netlify AI Gateway not enabled on account
- **Fix**: Explicit `baseURL: 'https://api.openai.com/v1'` in OpenAI provider config
- **Status**: Should be resolved

### ✓ Fixed: Trailing Slash Redirects (63eafab)
- **Symptom**: 308 redirects breaking streaming API responses
- **Cause**: `trailingSlash: true` in Next.js config
- **Fix**: Changed to `trailingSlash: false`
- **Status**: Should be resolved

### ✓ Fixed: AI SDK 5.0 Tool Calling (0c77dd8)
- **Symptom**: Empty responses when AI calls tools
- **Cause**: Using deprecated `toTextStreamResponse()`
- **Fix**: Changed to `toUIMessageStreamResponse()`
- **Status**: Should be resolved

### ⚠️ Potential Issue: Function Deployment
- **Symptom**: `netlify functions:list` shows NO functions
- **Expected**: Should show either individual API route functions OR the Next.js server handler
- **Status**: **NEEDS INVESTIGATION** - This is the primary concern

## Hypotheses to Test

### Hypothesis 1: Functions Not Actually Deployed
- Despite deployment API showing `___netlify-server-handler`, functions may not be accessible
- Build may have succeeded but function bundling failed
- Check: Netlify admin UI → Functions tab, deployment logs

### Hypothesis 2: Next.js Plugin Misconfiguration
- `@netlify/plugin-nextjs` may not be correctly handling standalone mode
- Plugin may be outdated for Next.js 15.5.3
- Check: Plugin compatibility, alternative deployment configurations

### Hypothesis 3: Monorepo/Workspace Issue
- `outputFileTracingRoot: '../'` may be causing deployment issues
- Netlify may not be correctly resolving pnpm workspace dependencies
- Check: Build logs for missing dependencies, function bundling errors

### Hypothesis 4: Middleware Interference
- Middleware may be intercepting API routes before they reach Next.js handler
- Supabase session refresh may be failing or hanging
- Check: Middleware logs, response headers, timing

### Hypothesis 5: Standalone Output Compatibility
- `output: 'standalone'` may be incompatible with Netlify Next.js plugin
- Plugin expects different output mode
- Check: Netlify Next.js plugin documentation, try removing standalone mode

## Recommended Investigation Path

1. **Immediate**: Access Netlify admin UI and check Functions tab
   - Screenshot what you see (should show deployed functions)
   - Check latest deployment logs for errors/warnings

2. **Next**: Analyze function logs for the error logging we added
   - Look for `[api/chat]` prefixed log entries
   - Identify exactly where the error is occurring

3. **Then**: Test a minimal API route
   - Create `/api/health/route.ts` with simple JSON response
   - Deploy and test if it works
   - This isolates whether ALL functions fail or just AI streaming endpoints

4. **Finally**: Based on findings, apply targeted fix:
   - If functions not deploying → Fix build/plugin configuration
   - If functions deploying but failing → Fix runtime error (auth, AI provider, etc.)
   - If only streaming fails → Fix streaming response configuration

## Success Criteria

- [ ] `netlify functions:list` shows deployed functions (or equivalent confirmation)
- [ ] `/api/chat` endpoint responds without Forbidden errors
- [ ] AI streaming works end-to-end in production
- [ ] Error logs show successful authentication and streamText() calls
- [ ] Both OpenAI and Anthropic providers work (if both API keys configured)

## Resources

- **Netlify Admin**: https://app.netlify.com/projects/app-startupai-site
- **Deployment Logs**: Check admin UI → Deploys → Latest deploy → Deploy log
- **Function Logs**: Check admin UI → Logs → Functions
- **Repository**: https://github.com/chris00walker/app.startupai.site
- **Latest Commit**: fb4c322 (error logging)

## Expected Deliverables

1. **Root Cause Analysis**: Clear explanation of why functions aren't showing/working
2. **Fix Implementation**: Code changes or configuration updates to resolve the issue
3. **Verification**: Proof that functions are deployed and working (logs, test results)
4. **Documentation**: Update this document with findings and final solution

---

**START HERE**: Begin by accessing the Netlify admin UI and checking the Functions tab and latest deployment logs. Report back your findings before proceeding with fixes.

## Investigation Notes – 2025-11-12

- Confirmed via `netlify api listSiteDeploys` that deploy `6913cf11fc86dc0008df71b3` bundles a single server handler (`___netlify-server-handler`), even though `netlify functions:list` reports an empty `netlify/functions` directory (expected because the CLI command only inspects the traditional functions folder).
- Added `scripts/simulate-authenticated-chat.mjs`, which signs into Supabase using the SSR helpers, starts/resumes an onboarding session, and then hits the production `/api/chat` endpoint so we can capture real `x-nf-request-id` values on demand.
- Streaming the function logs during those simulated sessions produced `AI_APICallError: Forbidden` entries that clearly show the AI SDK is still calling `https://app-startupai-site.netlify.app/.netlify/ai/messages`, meaning Netlify’s AI Gateway rewrite is still active.
- Root cause: Netlify injects `ANTHROPIC_BASE_URL=/.netlify/ai/messages` during builds. Our previous fix only forced a custom `baseURL` for OpenAI, so any environment with `ANTHROPIC_API_KEY` set would still be routed through the disabled gateway and return 403.
- Fix implemented: all three chat endpoints now construct their Anthropic provider via `createAnthropic({ apiKey, baseURL: 'https://api.anthropic.com/v1' })`, ensuring the SDK bypasses the Netlify proxy the same way the OpenAI branch already does. Each handler logs which provider/model is selected for easier future triage.
- Next steps after deploy: re-run `scripts/simulate-authenticated-chat.mjs` while tailing `netlify logs:function ___netlify-server-handler` to confirm the logged `url` no longer references `/.netlify/ai/messages` and that the stream completes without Forbidden errors.
